CREATE TABLE utenti (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  cognome VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  ruolo ENUM('cliente', 'amministratore') NOT NULL DEFAULT 'cliente'
);
CREATE TABLE prodotti (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  descrizione TEXT,
  prezzo DECIMAL(10,2) NOT NULL
);
CREATE TABLE ordini (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cliente_id INT NOT NULL,
  data DATETIME NOT NULL,
  stato ENUM('In corso', 'Completato', 'Annullato') NOT NULL DEFAULT 'In corso',
  numero_ordine VARCHAT(255),
  FOREIGN KEY (cliente_id) REFERENCES utenti(id)
);
CREATE TABLE articoli_ordine (
  id INT AUTO_INCREMENT PRIMARY KEY,
  ordine_id INT NOT NULL,
  prodotto_id INT NOT NULL,
  quantita INT NOT NULL,
  FOREIGN KEY (ordine_id) REFERENCES ordini(id),
  FOREIGN KEY (prodotto_id) REFERENCES prodotti(id)
);

CREATE VIEW riepilogo_ordini AS
SELECT
  ordini.id AS id_ordine,
  utenti.id AS id_utente,
  utenti.nome AS nome_cliente,
  utenti.cognome AS cognome_cliente,
  ordini.numero_ordine AS numero_ordine,
  ordini.data AS data_ordine,
  ordini.stato AS stato_ordine,
  SUM(articoli_ordine.quantita) AS quantita_totale,
  SUM(articoli_ordine.quantita * prodotti.prezzo) AS totale_ordine
FROM ordini
INNER JOIN utenti ON ordini.cliente_id = utenti.id
INNER JOIN articoli_ordine ON ordini.id = articoli_ordine.ordine_id
INNER JOIN prodotti ON articoli_ordine.prodotto_id = prodotti.id
GROUP BY ordini.id;

CREATE VIEW dettagli_ordini AS
SELECT
  ordini.id AS id_ordine,
  utenti.id AS id_utente,
  utenti.nome AS nome_cliente,
  utenti.cognome AS cognome_cliente,
  utenti.email AS email_cliente,
  ordini.data AS data_ordine,
  ordini.stato AS stato_ordine,
  ordini.numero_ordine AS numero_ordine,
  prodotti.nome AS nome_prodotto,
  prodotti.descrizione AS descrizione_prodotto,
  prodotti.prezzo AS prezzo_prodotto,
  articoli_ordine.quantita AS quantita_ordinata
FROM ordini
INNER JOIN utenti ON ordini.cliente_id = utenti.id
INNER JOIN articoli_ordine ON ordini.id = articoli_ordine.ordine_id
INNER JOIN prodotti ON articoli_ordine.prodotto_id = prodotti.id;


